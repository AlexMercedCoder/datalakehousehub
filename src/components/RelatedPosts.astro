---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import config from "@/config/config.json";
import similerItems from "@/lib/utils/similarItems";
import { plainify } from "@/lib/utils/textConverter";

const { post } = Astro.props;
const { summary_length } = config.settings;

const posts = await getCollection("blog");
let similarPosts = [];

if (post.data.relatedPosts && post.data.relatedPosts.length > 0) {
  similarPosts = posts.filter((p) => post.data.relatedPosts.includes(p.slug));
} else {
  similarPosts = similerItems(post, posts, post.slug);
}
---

{
  similarPosts.length > 0 && (
    <div class="section pb-0">
      <h2 class="mb-8 text-center h3">Related Posts</h2>
      <div class="row justify-center">
        {similarPosts.slice(0, 3).map((post) => (
          <div class="col-12 mb-8 sm:col-6 lg:col-4">
             <div class="bg-white dark:bg-darkmode-theme-light rounded-lg shadow p-4 h-full">
                <a
                    href={`/blog/${post.slug}`}
                    class="block hover:text-primary transition duration-300"
                >
                    <img
                    src={`/open-graph/${post.slug}.png`}
                    alt={post.data.title}
                    width={445}
                    height={230}
                    class="w-full rounded-lg bg-gray-200 dark:bg-gray-800"
                    />
                </a>
                <div class="mt-4">
                    <h3 class="h4 mb-2">
                        <a
                        href={`/blog/${post.slug}`}
                        class="block hover:text-primary transition duration-300"
                        >
                        {post.data.title}
                        </a>
                    </h3>
                    <p class="text-text dark:text-light mb-4 text-sm">
                        {plainify(post.body?.slice(0, Number(summary_length)))}...
                    </p>
                </div>
            </div>
          </div>
        ))}
      </div>
    </div>
  )
}
